

#### 6.2.3 输出解析器

使用输出解析器（OutputParser）可以使模型的输出更加结构化。下面是一些常见的输出解析器及其功能。

- **get_format_instructions**：指示模型如何格式化输出。通过调用该输出解析器，可以获取有关如何格式化输出的指示。 

- **parse(str)**：将输出解析为所需的格式。该输出解析器接收一个字符串参数，并将其解析为所需的格式。 

- **CommaSeparatedListOutputParser**：以逗号分隔的形式返回输出。例如，将一个列表['Vanilla', 'Chocolate', 'Strawberry', 'Mint Chocolate Chip', 'Cookies and Cream']解析为以逗号分隔的字符串。 

- **StructuredOutputParser**：生成结构化的内容，无须定义对象。该输出解析器类似于PydanticOutputParser，但不需要定义对象。 

- **PydanticOutputParser**：定义一个对象模型，使模型按照该对象模型返回数据。可以定义一个Pydantic对象模型，并使用该输出解析器将输出解析为该对象模型的实例。 

#### 6.2.4 索引

索引是一种将文档结构化的工具，使模型能够直接与文档更好地进行交互，如用于答疑、知识库等场景。模型可以从文档中获取答案。

LangChain在索引方面提供了许多有用的函数和工具，以便人们加载和检索不同的文档数据，主要工具如下。

- **Document Loaders（文档加载工具）**：从不同的数据源加载文档。当使用文档加载工具读取数据源后，需要将数据源转换为Document对象，以便后续使用。 

- **Text Splitter（文本分割工具）**：实现文本分割。无论是将文本作为提示发送给OpenAI API，还是使用OpenAI API的嵌入功能，都有字符限制。因此，需要使用文本分割工具来分割文档加载工具加载的文档。 

- **Vector Store（向量存储工具）**：将文档存储为向量结构。因为数据的相关性搜索实际上是向量运算，所以无论是使用OpenAI API的嵌入功能，还是直接通过向量数据库进行查询，都需要将加载的文档转换为向量，以进行向量运算。将加载的文档转换为向量非常简单，只需将数据存储到相应的向量数据库中即可。图6 - 2中的FAISS是一种用于存储向量的向量数据库。 

![image](https://github.com/user-attachments/assets/dc4fcec7-563f-4a19-b3b8-19f8168a8135)


[图6 - 2向量存储的服务图，展示Document(s)经LangChain Text Splitter分割成块，再由OpenAI Embeddings创建向量嵌入，存储到Vector Store（FAISS）]

- **Retriever（检索工具）**：用于检索文档数据。 

下面通过一个案例来了解不同工具的用法。

- **加载文档数据**：可以使用文档加载工具来完成。文档加载工具可以从文件、数据库或网络中获取文档数据，并将其准备好以供后续处理。 

- **将文本分割为不同的块**：可以使用文本分割工具来完成。文本分割工具可以将长文本分割成更小的部分，以便于后续处理和检索。 

- **将分割后的文本块转换为向量存储**：可以使用向量存储工具来完成。向量存储工具可以将文本数据转换为向量表示形式，以便于计算和比较。 

- **检索文档数据并将其提供给LangChain以进行问答处理**：可以使用检索工具来完成。检索工具可以根据用户的查询，从向量存储工具中检索出最相关的文本块，并将其提供给LangChain以进行问答处理。 

#### 6.2.5 内存

在默认情况下，代理和链都是无状态的，这意味着它们在处理完每次查询后不会记住上一次对话的内容，每次查询都是独立的。

然而，在某些场景（如聊天场景）下，记住上一次对话的内容是非常重要的。为了满足这种需求，LangChain提供了一些相关的工具类。

这些工具类可以用于在代理和链之间传递上下文信息，以便于在连续的对话中保持对话状态。例如，可以使用上下文工具类来存储和提取上一次对话的内容，这样在下一次查询时，便可以使用这些信息来提供更准确的回答。

通过使用LangChain提供的工具类，可以在需要记住上一次对话内容的应用中实现更强大的对话功能。这样就能够更好地满足用户的需求，为用户提供个性化、连贯的对话体验。

#### 6.2.6 链

链的设计使我们可以将多个组件组合成一个应用。例如，我们可以创建一个链，它可以接收用户输入，先使用提示模板格式化用户输入为提示，然后将这些提示输入语言模型。

此外，我们还可以将多个链组合在一起，以构建更复杂的链。这样，每个链负责特定的功能或任务，而整个应用则可以通过这些链的组合实现更加复杂和完整的功能。

通过将多个链组合在一起，可以实现更高级的对话流程和逻辑。每个链负责特定的功能或任务，如输入处理、语义解析、上下文管理等。这种组合的方式使我们可以更灵活地构建应用，并根据需求进行定制和扩展。链是一个简单的工具，它接收一个提示模板，在用户提供输入后对其进行格式化处理，并将格式化后的内容传递给语言模型，从而获得相应的响应，如图6 - 3所示。

![image](https://github.com/user-attachments/assets/ffdf3d26-8532-4537-9e26-eead24ac846c)


[图6 - 3链的执行流程，展示用户输入经提示模板处理后进入语言模型]

#### 6.2.7 代理

代理使用语言模型作为思考工具来决定当前要执行的操作。我们会为代理提供一系列的工具，代理会根据用户输入判断采用哪些工具可以实现目标，并持续地运行这些工具以实现目标。

代理可以视为增强版的链，它不仅绑定了提示模板和语言模型，还可以添加其他工具。

代理是一个智能代理，其职责是根据用户输入和应用场景，在一系列可用的工具中选择合适的工具来执行操作。代理可以根据任务的复杂性采用不同的策略来决定如何执行操作。这意味着代理可以根据具体情况来选择最佳的工具，以实现高效和准确地执行操作。

总之，代理是一个使用语言模型作为思考工具的智能代理，它可以根据用户输入和应用场景选择合适的工具来执行操作，并根据任务的复杂性采用不同的策略来决定如何执行操作。这使代理能够更加灵活和智能地完成各种任务。

目前主要有两种类型的代理。

- **动作代理（Action Agent）**：这种代理一次执行一个动作，根据执行结果决定下一步的操作。 

- **计划执行代理（Plan-and-Execute Agent）**：这种代理先确定一系列要执行的操作，然后按照事先确定的顺序逐个执行操作。 



对于简单的任务来说，动作代理更为常见且易于实现。对于复杂或长期运行的任务来说，计划执行代理的初始规划步骤有助于维持长期目标并保持关注。然而，计划执行代理的使用可能会增加调用次数并引入较高的延迟。这两种代理并不是互斥的，可以让动作代理负责执行计划执行代理所制订的计划。



代理内部涉及的核心概念如下。

- **代理**：代理是应用程序的主要逻辑。它提供一个接口，接收用户输入和代理已执行的操作列表，并返回AgentAction或AgentFinish。 

- **工具**：工具是代理可以采取的动作，如发起HTTP请求、发送邮件、执行命令等。 

- **工具包**：工具包是为特定用例设计的一组工具。例如，为了使代理能够以最佳方式与SQL数据库交互，可能需要一个执行查询操作的工具和一个查看表格的工具。工具包可以看作工具的集合。 

- **代理执行器**：代理执行器将代理与一系列工具包装在一起，负责迭代运行代理，直到满足停止条件为止。 

1. **代理的执行流程**：LangChain在接收到用户的问题后，会将问题拆解成各个子任务。Llama 2根据任务的不同会调用相应的工具，并通过这些工具与外部环境进行交互。交互结果会传递给Llama 2进行处理，最后代理将处理后的最终结果返回给用户。代理的执行流程如图6 - 4所示。

![image](https://github.com/user-attachments/assets/1ade69c6-4209-428d-ab3e-b4b10001f4f4)


[图6 - 4代理的执行流程，展示Task经LLM处理后调用Tools与Environment交互，交互结果Result返回LLM进行Reasoning]

2. **代理类型**：在下面的代码中，关于代理的初始化阶段，有一个代理类型的设定，如agent=AgentType.ZERO_SHOT_REACT_DESCRIPTION。代理类型决定了代理如何使用工具、处理输入及与用户进行交互，从而为用户提供有针对性的服务。

```python
initialize_agent(tools, llm,
agent=AgentType.ZERO_SHOT_REACT_DESCRIPTION, verbose=True)
```

以下是可选择的代理类型。

以下是可选择的代理类型。
（1）ZERO-SHOT-REACT-DESCRIPTION：该代理使用ReAct框架，仅根据工具的描述确定要使用哪个工具。它可以提供任意数量的工具，每个工具都需要提供一个描述。
（2）React-Docstore：该代理使用ReAct框架与文档存储（Docstore）进行交互。必须提供两个工具：搜索工具和查找工具（必须确切地将它们命名为Search和Lookup）。搜索工具用于搜索文档，查找工具用于在最近找到的文档中查找术语。该代理类似于原始的ReAct论文中的示例，特别是维基百科的示例。
（3）Self-Ask-With-Search：该代理使用一个名为Intermediate Answer的单一工具。该工具应能够查找问题的事实性答案。该代理类似于原始的自问自答（Self-Ask）与搜索论文，其中提供了Google搜索引擎API作为工具。
（4）Conversational-React-Description：该代理用于对话设置。提示可以帮助代理在对话中变得有用。它使用ReAct框架来决定使用哪个工具，并使用内存来记住之前的对话内容。
（5）Structured-Chat-Zero-Shot-React-Description：该代理可以在对话中使用任意的工具，并且能够记住对话的上下文。

### 6.2.8 工具
LangChain官方默认提供了一系列工具箱，包括发Gmail邮件、数据库查询、JSON处理等。此外，还有一些单个工具的列表，可以在文档中查看。


为了更好地介绍工具的使用方法，下面通过一个自定义工具来进行说明。因为在使用LangChain时，我们的主要任务是不断地自定义工具。在编写工具时，需要准备以下内容。

（1）名称：给工具起一个合适的名称。

（2）工具描述：清楚地说明工具的功能和用途。

（3）参数结构：明确当前工具所需的输入参数的结构。



在下面的例子中，我们使用Tool数据类来创建一个名为“搜索”的新工具，该工具使用SerpAPI包装器来回答有关当前事件的问题。

```python
class CustomSearchTool(BaseTool):
    name = "搜索"
    description = "当你需要回答有关当前事件的问题时有用"
    def _run(self, query: str) -> str:
        """使用工具。"""
        return search.run(query)
    async def _arun(self, query: str) -> str:
        """异步使用工具。"""
        raise NotImplementedError("BingSearchRun不支持异步")

class CustomCalculatorTool(BaseTool):
    name = "计算器"
    description = "用于进行数学计算"
    def _run(self, query: str, calculator=None) -> str:
        """使用工具。"""
        return calculator.run(query)
    async def _arun(self, query: str) -> str:
        """异步使用工具。"""
        raise NotImplementedError("CustomCalculatorTool不支持异步")
```


### 6.3 LangChain环境配置

本节将介绍Python在各个平台（如Windows、macOS、Linux）上的安装示例，以及LangChain的配置方法，以帮助用户更轻松地使用LangChain。安装和配置完成后，用户便可以愉快地使用LangChain了。

#### 6.3.1 Python环境搭建

1. **Python下载**：Python最新源代码、二进制文档、新闻资讯等可以在Python的官方网站查看。

2. **Python安装**：在Windows平台上安装Python的步骤如下。

（1）**下载Python安装包**：打开Python的官方网站：https://www.python.org/。单击“Downloads”（下载）选项卡，选择适用于Windows平台的Python版本。建议下载最新版。

（2）**运行Python安装程序**：双击下载的Python安装程序。在打开的窗口中可以看到几个安装选项。建议勾选“Add Python to PATH”（将Python添加到PATH环境变量中）复选框，这样就可以使用命令提示符直接运行Python安装程序。单击“Install Now”（现在安装）按钮进行安装。

（3）**安装进程**：安装程序时会显示一个进度条，告知用户安装过程的状态。安装完成后将看到一个“Setup was successful”（安装成功）的提示。

（4）**验证安装**：打开命令提示符窗口。输入“python --version”，按回车键。如果Python已成功安装，那么系统将显示Python的版本信息。

#### 6.3.2 LangChain主要模块

LangChain主要模块是一个集成了许多模块和工具的库。但是在开始开发之前，可能还需要安装一些额外的包，可以使用pip命令来安装这些包：

```python

python3 -m pip install --upgrade langchain deeplake pinecone-client Openai tiktoken python-dotenv

```

下面对在这里所做的工作进行详细的介绍。

首先，使用python3 -m pip命令确保我们使用的是Python3解释器的正确版本的pip模块。

其次，使用install命令安装所需的Python包。这些包的名称分别是langchain、deeplake、pinecone-client、Openai、tiktoken和python-dotenv。通过运行install命令，可以安装这些包的最新版本。



下面是每个包的简要说明。

（1）**langchain**：langchain是主要的Python包，它提供文档加载工具、文本分割工具和其他实用工具。

（2）**deeplake**：deeplake是一个向量数据库提供者。我们需要将处理过的数据存储为向量形式，因此需要一个向量数据库。deeplake允许用户轻松地在本地或云上创建索引，因此我们通常会选择安装它。

（3）**pinecone-client**：pinecone-client是另一个用于机器学习应用的向量数据库，可能是最知名的一个。它可靠且性能出色，但可能需要用户在等候名单上注册。

（4）**Openai**：Openai是用于OpenAI API的官方Python库，它允许用户访问 



